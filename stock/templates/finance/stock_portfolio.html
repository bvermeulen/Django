{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_tags %}

{% block title %}Portfolio{% endblock %}

{% block stylesheet %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/container-styles.css' %}">
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb my-4">
  <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
  <li class="breadcrumb-item"><a href="{% url 'stock_quotes' %}">Stock Quotes</a></li>
  <li class="breadcrumb-item active">Portfolio</li>
</ol>
{% endblock %}

{% block content %}
  <form id="id_portfolio" method="post">
    {% csrf_token %}
    <a style="display: none">{{ form.new_portfolio }} {{ form.quantity }} 
      {{ form.portfolios }} {{ form.currencies }}</a>
    <div class="flex-container">
      <div style="width:12%">
        <button class="btn btn-primary btn-sm"
        onclick="return AskNewName()">New portfolio</button>
      </div>

      <div style="width:50%">
        {{ form.portfolio_name }}
        <button class="btn btn-outline-primary btn-sm" name="btn1_pressed"
          value="rename_portfolio">Rename</button>
        <button class="btn btn-primary btn-sm mr-5" name="btn1_pressed"
          value="delete_portfolio"
          onclick="return ConfirmDelete('{{ form.portfolio_name.value }}')">Delete</button>
        {{ form.symbol }}
        <button class="btn btn-outline-primary btn-sm" name="btn1_pressed"
            value="add_new_symbol">Add symbol</button>
      </div>

      <div style="width:38%">
        <strong class="mr-2">Portfolio value:</strong>
        <strong class="mr-2">{{ stocks_value }}</strong>
        <div class="dropdown">
          <button type="button" class="btn dropdown-toggle btn-outline-primary btn-sm">{{ form.currencies.value }}</button>
          <div class="dropdown-content">
            {% for currency in form.currencies %}
                {% if not currency.data.selected %}
                  <p>
                  <button class="btn btn-link" value="{{ currency.data.value}}"
                    name="{{ currency.data.name }}"><a>{{ currency.choice_label }}</a>
                  </button>
                  </p>
                {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="flex-container" style="height:70vh">
      <div class="scroll mt-5 mr-1" style="width:12%; height:40vh">

        {% for portfolio in form.portfolios %}
          <p>
          {% if portfolio.data.selected %}
            <button type="button" class="btn btn-primary btn-sm">
              {{ portfolio.choice_label }}</button>

          {% else %}
            <button type="submit" class="btn btn-light btn-sm"
              value="{{ portfolio.data.value }}" name="{{ portfolio.data.name }}">
                {{ portfolio.choice_label }}</button>

          {% endif %}
          </p>
        {% endfor %}
      </div>

      <div style="width:88%; height:100%">
        <table class="table table-fixed table-striped mb-2 mt-1 table-sm">
          <thead class="col-sm-8 custom-thead-grey">
            <tr>
              <th colspan="3">Company</th>
              <th colspan="2">Symbol</th>
              <th colspan="2">Currency</th>
              <th colspan="2">Price</th>
              <th colspan="2">Qty</th>
              <th colspan="2">Amount</th>
              <th colspan="2"></th>
              <th colspan="2"></th>
            </tr>
          </thead>
          <tbody class="scroll">
            {% for stock in stocks %}
              <tr>
                <td colspan="3">{{ stock.name|truncatechars:15 }}</td>
                <td colspan="2">{{ stock.symbol }}</td>
                <td colspan="2">{{ stock.currency }}</td>
                <td colspan="2">{{ stock.price }}</td>
                <td colspan="2">{{ stock.quantity }}</td>
                <td colspan="2">{{ stock.amount }}</td>
                <td colspan="2">
                  <button class="btn btn-outline-secondary btn-sm" name="btn2_pressed"
                          value="{{ stock.symbol }}, "
                          onclick="return ChangeQuantity('{{ stock.name }}',
                                                         '{{ stock.quantity }}',
                                                         '{{ forloop.counter0 }}')">Change</button>
                </td>
                <td colspan="2">
                  <button class="btn btn-outline-secondary btn-sm" name="btn2_pressed"
                          value="{{ stock.symbol }}, delete" onclick="return ConfirmDelete('{{ stock.name }}' )">Delete</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  </form>
  <br><br><br><br>
{% endblock content %}

{% block javascript %}
<script>
var form = document.getElementById('id_portfolio');

function AskNewName() {
  var newPortfolio = prompt('What is the name of the new portfolio', '');

  if (newPortfolio != null && newPortfolio != '') {
    form.new_portfolio.value = newPortfolio;
    return true;
  }
  else {
    return false;
  }
}

function ChangeQuantity(name, qty, counter) {
  var newQuantity = prompt('Change quantity for ' + name, qty);

  newQuantity = parseFloat(newQuantity);
  qty = parseFloat(qty);
  counter = parseFloat(counter);

  if (newQuantity >= 0 && newQuantity != qty) {
    form.btn2_pressed[2*counter].value +=  newQuantity;
    return true;
  }
  else {
    return false;
  }
}

function ConfirmDelete(value) {
  confirmed = confirm('Do you really want to delete ' + value + '?');
  if (confirmed) {
    return true;
  }
  else {
    return false;
  }
}
</script>
{% endblock %}
